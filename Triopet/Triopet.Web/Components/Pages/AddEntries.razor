@page "/addentry"
@page "/editentry/{Id:int}"
@inject NavigationManager NavigationManager
@inject IApiService ApiService
@inject ISnackbar Snackbar
@using Triopet.Shared.Models
@rendermode InteractiveServer

<MudSnackbarProvider />

@if (Id > 0)
{
    <h3>Edit Entry</h3>
}
else
{
    <h3>Add Entry</h3>
}

<EditForm Model="NewEntry" OnValidSubmit="OnAddEntry">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label>Produto:</label>
        <select class="form-control" @bind="NewEntry.ProductEntries[0].ProductId">
            <option value="">Selecione um produto</option>
            @foreach (var prod in Products)
            {
                <option value="@prod.Id">@prod.Name</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label>Quantidade:</label>
        <input type="number" @bind="NewEntry.ProductEntries[0].Quantity" class="form-control" />
    </div>

    <div class="form-group">
        <label>Preço:</label>
        <input type="number" @bind="NewEntry.ProductEntries[0].PriceUnitOfEntry" class="form-control" />
    </div>

    @*     Rever acima quantidade
 *@
    <nav class="mt-3">
        <button class="btn btn-primary" type="submit">@buttonText</button>
        <button @onclick="Voltar" type="button" class="btn btn-secondary mt-2 ms-2">Voltar</button>
    </nav>

    <ValidationSummary />
</EditForm>

@if (!string.IsNullOrEmpty(Mensagem))
{
    <p class="text-success mt-3">@Mensagem</p>
}

@code {
    [Parameter]
    public int Id { get; set; }

    public string buttonText => Id > 0 ? "Save" : "Add";

    private List<ProductDto> Products = new();

    public EntryDto NewEntry = new();
    private string Mensagem = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Products = await ApiService.GetProductsAsync();

        if (Id > 0)
        {
            var entry = await ApiService.GetEntryById(Id);
            if (entry != null)
            {
                NewEntry = entry;
            }
        }
    }

    private async Task OnAddEntry()
    {
        if (Id > 0)
        {
            var response = await ApiService.UpdateEntry(NewEntry);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Entrada atualizada com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao atualizar entrada", Severity.Error);
            }
        }
        else
        {
            var response = await ApiService.CreateNewEntry(NewEntry);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Entrada registrada com sucesso!", Severity.Success);
                NewEntry = new EntryDto();
            }
            else
            {
                Snackbar.Add("Erro ao registrar entrada", Severity.Error);
            }
        }
    }

    private void Voltar()
    {
        NavigationManager.NavigateTo("/");
    }
}
